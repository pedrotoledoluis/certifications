
# ğŸ˜ AWS Lambda con C# (.NET Core) y PostgreSQL

Este ejemplo demuestra cÃ³mo usar AWS Lambda para conectarse a una base de datos PostgreSQL y recuperar una lista de usuarios. El cÃ³digo ha sido refactorizado aplicando buenas prÃ¡cticas y principios de Clean Code.

---

## âœ… Requisitos Previos

- .NET 6 o 7
- PostgreSQL configurado y accesible
- Tabla `usuarios` con columnas: `id`, `nombre`, `email`
- AWS Lambda configurada
- Paquete NuGet: `Npgsql`

```bash
dotnet add package Npgsql
```

---

## ğŸ“ Estructura del Proyecto

```
MiLambdaPostgre/
â”œâ”€â”€ Models/
â”‚   â””â”€â”€ Usuario.cs
â”œâ”€â”€ Services/
â”‚   â””â”€â”€ PostgreSqlService.cs
â”œâ”€â”€ Function.cs
â””â”€â”€ MiLambdaPostgre.csproj
```

---

## ğŸ§¾ `Models/Usuario.cs`

```csharp
namespace MiLambdaPostgre.Models;

public class Usuario
{
    public int Id { get; set; }
    public string Nombre { get; set; }
    public string Email { get; set; }
}
```

---

## ğŸ› ï¸ `Services/PostgreSqlService.cs`

```csharp
using System.Collections.Generic;
using MiLambdaPostgre.Models;
using Npgsql;

namespace MiLambdaPostgre.Services;

public class PostgreSqlService
{
    private readonly string _connectionString;

    public PostgreSqlService(string connectionString)
    {
        _connectionString = connectionString;
    }

    public List<Usuario> ObtenerUsuarios()
    {
        var usuarios = new List<Usuario>();

        using var conn = new NpgsqlConnection(_connectionString);
        conn.Open();

        using var cmd = new NpgsqlCommand("SELECT id, nombre, email FROM usuarios", conn);
        using var reader = cmd.ExecuteReader();

        while (reader.Read())
        {
            usuarios.Add(new Usuario
            {
                Id = reader.GetInt32(0),
                Nombre = reader.GetString(1),
                Email = reader.GetString(2)
            });
        }

        return usuarios;
    }
}
```

---

## ğŸ’¡ `Function.cs`

```csharp
using Amazon.Lambda.Core;
using MiLambdaPostgre.Models;
using MiLambdaPostgre.Services;
using System;
using System.Collections.Generic;

[assembly: LambdaSerializer(typeof(Amazon.Lambda.Serialization.SystemTextJson.DefaultLambdaJsonSerializer))]

namespace MiLambdaPostgre;

public class Function
{
    private readonly PostgreSqlService _dbService;

    public Function()
    {
        var connectionString = Environment.GetEnvironmentVariable("POSTGRES_CONNECTION_STRING");
        if (string.IsNullOrEmpty(connectionString))
            throw new Exception("POSTGRES_CONNECTION_STRING no estÃ¡ definido en las variables de entorno");

        _dbService = new PostgreSqlService(connectionString);
    }

    public List<Usuario> FunctionHandler(string input, ILambdaContext context)
    {
        context.Logger.LogInformation("ğŸ” Iniciando recuperaciÃ³n de usuarios...");
        var usuarios = _dbService.ObtenerUsuarios();
        context.Logger.LogInformation($"âœ… {usuarios.Count} usuarios recuperados.");
        return usuarios;
    }
}
```

---

## ğŸ” Uso de Secrets Manager (opcional)

Si prefieres usar Secrets Manager en lugar de variables de entorno, puedes integrarlo con el SDK de AWS para recuperar la cadena de conexiÃ³n segura.

---

## ğŸ’¡ Buenas PrÃ¡cticas Aplicadas

- ğŸ” **No incluir credenciales directamente en el cÃ³digo**
- ğŸ’¬ **Logging claro** con `context.Logger`
- ğŸ”„ **ReutilizaciÃ³n de cÃ³digo** con un servicio de base de datos
- ğŸ“¦ **Modelo de datos explÃ­cito** (`Usuario`)
- ğŸ§© **SeparaciÃ³n de responsabilidades**

---

## ğŸš€ Despliegue

Puedes desplegar este proyecto:

- Como archivo ZIP desde AWS Console
- Usando `dotnet lambda deploy-function`
- Usando AWS CDK o SAM

